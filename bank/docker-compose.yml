version: '3.8'

services:
  # MySQL Database for Customer Service
  mysql-customer:
    image: mysql:8.0
    container_name: mysql-customer
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: customer_db
    ports:
      - "3307:3306"
    volumes:
      - mysql-customer-data:/var/lib/mysql
      - ./init-scripts/init-customer.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MySQL Database for Account Service
  mysql-account:
    image: mysql:8.0
    container_name: mysql-account
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: account_db
    ports:
      - "3308:3306"
    volumes:
      - mysql-account-data:/var/lib/mysql
      - ./init-scripts/init-account.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MySQL Database for Authentication Service
  mysql-auth:
    image: mysql:8.0
    container_name: mysql-auth
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: db_user_new_devs_nours
    ports:
      - "3309:3306"
    volumes:
      - mysql-auth-data:/var/lib/mysql
      - ./init-scripts/init-auth.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Axon Server (using axonserver.jar)
  axon-server:
    image: axon-server
    container_name: axon-server
    build:
      context: ..
      dockerfile: ./bank/axon-server/Dockerfile
    ports:
      - "8024:8024"  # HTTP port
      - "8124:8124"  # gRPC port
    volumes:
      - axon-server-data:/app/data
    networks:
      - bank-network
    environment:
      - AXONSERVER_HOSTNAME=axon-server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8024/actuator/health || curl -f http://localhost:8024 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Discovery Service (Eureka)
  discovery-service:
    image: discovery-service
    container_name: discovery-service
    build:
      context: ./discovery-service
    ports:
      - "8761:8761"
    depends_on:
      axon-server:
        condition: service_healthy
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Gateway Service
  gateway-service:
    image: gateway-service
    container_name: gateway-service
    build:
      context: ./gateway-service
    ports:
      - "8888:8888"
    environment:
      - DISCOVERY_SERVICE=http://discovery-service:8761/eureka/
      - ALLOWED_ORIGINS=http://localhost:4200,http://localhost:8089
    depends_on:
      discovery-service:
        condition: service_healthy
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Notification Service
  notification-service:
    image: notification-service
    container_name: notification-service
    build:
      context: ./notification-service
    ports:
      - "8887:8887"
    environment:
      - DISCOVERY_SERVICE=http://discovery-service:8761/eureka/
      - MAIL_HOST=smtp4dev
      - MAIL_PORT=25
      - MAIL_USERNAME=
      - MAIL_PASSWORD=
      - EMAIL_SYSTEM=test@bank.com
    depends_on:
      discovery-service:
        condition: service_healthy
      gateway-service:
        condition: service_healthy
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8887/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Authentication Service
  authentication-service:
    image: authentication-service
    container_name: authentication-service
    build:
      context: ./authentication-service
    ports:
      - "8885:8885"
    environment:
      - DISCOVERY_SERVICE=http://discovery-service:8761/eureka/
      - MYSQL_USER=root
      - MYSQL_PWD=root
      - MYSQL_HOST=mysql-auth
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=db_user_new_devs_nours
      - JWT_SECRET=AaZzBbCcYyDdXxEeWwFf
      - JWT_EXPIRATION=604800000
    depends_on:
      mysql-auth:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      gateway-service:
        condition: service_healthy
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8885/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Customer Service
  customer-service:
    image: customer-service
    container_name: customer-service
    build:
      context: ./customer-service
    ports:
      - "8886:8886"
    environment:
      - DISCOVERY_SERVICE=http://discovery-service:8761/eureka/
      - MYSQL_USER=root
      - MYSQL_PWD=root
      - MYSQL_HOST=mysql-customer
      - MYSQL_PORT=3306
      - DATABASE=customer_db
      - MYSQL_DATABASE=customer_db
      - JWT_SECRET=AaZzBbCcYyDdXxEeWwFf
      - JWT_EXPIRATION=604800000
    depends_on:
      mysql-customer:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      gateway-service:
        condition: service_healthy
      notification-service:
        condition: service_healthy
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8886/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Account Service
  account-service:
    image: account-service
    container_name: account-service
    build:
      context: ./account-service
    ports:
      - "8884:8884"
    environment:
      - DISCOVERY_SERVICE=http://discovery-service:8761/eureka/
      - MYSQL_USER=root
      - MYSQL_PWD=root
      - MYSQL_HOST=mysql-account
      - MYSQL_PORT=3306
      - DATABASE=account_db
      - MYSQL_DATABASE=account_db
      - AXON_HOST=axon-server
      - AXON_PORT=8124
      - AXON_CONSOLE=df10b708-0:6p47cea5j2ff4ae0a17p227163886825
      - JWT_SECRET=AaZzBbCcYyDdXxEeWwFf
      - JWT_EXPIRATION=604800000
    depends_on:
      mysql-account:
        condition: service_healthy
      axon-server:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      gateway-service:
        condition: service_healthy
      customer-service:
        condition: service_healthy
    networks:
      - bank-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8884/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Locust for Load Testing
  locust:
    image: locustio/locust:latest
    container_name: locust
    ports:
      - "8089:8089"  # Web UI
      - "5557:5557"  # Master port
      - "5558:5558"  # Worker port
    volumes:
      - ./locustfile.py:/locust/locustfile.py
      - ./requirements-locust.txt:/locust/requirements.txt
    command: sh -c "pip install -r /locust/requirements.txt && locust -f /locust/locustfile.py --host=http://gateway-service:8888 --web-host=0.0.0.0 --html=/locust/report.html --logfile=/locust/locust.log"
    depends_on:
      gateway-service:
        condition: service_healthy
      account-service:
        condition: service_healthy
      customer-service:
        condition: service_healthy
      authentication-service:
        condition: service_healthy
    networks:
      - bank-network
    environment:
      - LOCUST_STATS_HISTORY_ENABLED=true

volumes:
  mysql-customer-data:
  mysql-account-data:
  mysql-auth-data:
  axon-server-data:
  axon-server-events:

networks:
  bank-network:
    driver: bridge
    name: bank-network
